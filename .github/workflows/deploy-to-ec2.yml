name: Deploy Clash of Clans to EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

env:
  FRONTEND_DIR: .
  BACKEND_DIR: ./backend
  TARGET_FRONTEND_DIR: /var/www/html
  TARGET_BACKEND_DIR: /home/ec2-user/backend
  TMP_DIR: /tmp/repo-tmp

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key
        env:
          SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${EC2_PORT:-22} ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy frontend to Apache
        run: |
          tar -C ${FRONTEND_DIR} -czf - . | \
          ssh -p ${EC2_PORT:-22} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ${TMP_DIR} && tar -xzf - -C ${TMP_DIR}"
          ssh -p ${EC2_PORT:-22} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          if [ -d ${TARGET_FRONTEND_DIR} ] && [ \"\$(ls -A ${TARGET_FRONTEND_DIR} || true)\" != \"\" ]; then
            sudo mv ${TARGET_FRONTEND_DIR} ${TARGET_FRONTEND_DIR}-backup-\$TIMESTAMP
          else
            sudo mkdir -p ${TARGET_FRONTEND_DIR}
          fi
          sudo cp -r ${TMP_DIR}/* ${TARGET_FRONTEND_DIR}/
          sudo chown -R ec2-user:ec2-user ${TARGET_FRONTEND_DIR}
          sudo chmod -R 755 ${TARGET_FRONTEND_DIR}
          sudo systemctl restart httpd || sudo service httpd restart
          rm -rf ${TMP_DIR}"

      - name: Deploy backend with PM2
        run: |
          tar -C ${BACKEND_DIR} -czf - . | \
          ssh -p ${EC2_PORT:-22} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ${TARGET_BACKEND_DIR} && tar -xzf - -C ${TARGET_BACKEND_DIR}"
          ssh -p ${EC2_PORT:-22} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
          cd ${TARGET_BACKEND_DIR}
          npm install
          pm2 start app.js --name clash-backend --update-env || pm2 restart clash-backend --update-env
          pm2 save
          "
